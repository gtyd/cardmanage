{%include "layout/header"%}
<link rel="stylesheet" href="/public/css/style.css"/>
<div class="body cls"  ng-app="card" ng-controller="body">
    <div id="header" class="header" ng-controller="head">
        <h2>敏捷管理平台</h2>
        <form id="filter" class="filter">
            <label for="groupfilter">组：</label>
            <select ng-cloak name="groupfilter" id="groupfilter" ng-model="teamId"  ng-change="change()">
                <option ng-repeat="val in teams" value="{{val.teamId}}">{{val.teamName}}</option>
            </select>
           <label for="dateselect">区间：</label>
            <select ng-cloak name="dateselect" id="dateselect" ng-model="sprintId"  ng-change="change()">
                <option ng-repeat="val in sprints" value="{{val.id}}">{{val.name}}</option>
            </select>
            <label for="filterpeo">责任人：</label>
            <select ng-cloak name="dateselect" id="filterpeo" ng-model="ownerId" ng-change="change(1)">
                <option ng-repeat="val in companyPeople" value="{{val.objectId}}">{{val.displayName}}</option>
            </select>
        </form>
        <a class="statistics" href="{{statistics}}">查看统计</a>
        {%if user.role=='admin'%}&nbsp;&nbsp;
        <a href="/admin">管理后台</a>
        {%/if%}
        <span class="user" ng-cloak>欢迎：{%user.displayName%} &nbsp;<a href="/logout">退出</a></span>
    </div>
    <div id="content" ng-cloak class="content cls" ng-controller="list">
        <table class="table">
            <thead>
                <tr>
                    <td style="width:140px;">故事 <em title="新建故事" ng-click="addcard({'type':'story'})">添加</em></td>
                    <td ng-if="expendind | expend:$index" ng-repeat="value in cardType">{{value}} <span class="screen" ng-click="screen($index)"><i class="unfold">{{expendind != $index?'﹥':'﹤'}}  </i></span></td>
                </tr>
            </thead>
            <tbody>
                <tr ng-if="lineobj | showline" ng-repeat="lineobj in cardList | orderBy:orderfunc:'reverse'">
                    <td>
                        <div class="story-card" ng-dblclick="cardclick(lineobj.story)">
                            {{lineobj.story.title}}
                            <div class="story-add-card" ng-click="addcard({'parentId':lineobj.story.objectId,'parentName':lineobj.story.title})" title="添加任务">+</div>
                        </div>
                    </td>
                    <td masonry ng-if="expendind | expend:$index" dropable dataitem="cardtype" ng-repeat="cardtype in lineobj.cards" data-parentid="{{lineobj.story.objectId}}">
                        <div classify="{{item.cardClass}}" ng-if="item | filterpeople:filterid" draggable item="item" itemtype="cardtype" class="card masonry-brick"  ng-dblclick="cardclick(item)" ng-repeat="item in cardtype.list | orderBy:'weight':'reverse'">
                            <h4>{{item.title}}</h4>
                            <ul class="ownerslist cls">
                                <li class="name owner">责任人: {{item.owners | ownersname}}</li>
                            </ul>
                            <div class="completetime"><span class="owner">时间: {{item.amount}}天
                                <span class="date-range" ng-if="(item.startTime&&item.endTime)">{{item.startTime | ftime }}~{{item.endTime | ftime}}</span></span></div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="carddetail scroll-wrap" ng-cloak ng-show="show" ng-controller="cardDetail" paste>
        <form class="addcard ng-pristine ng-valid" ng-submit="submit()">
            <div class="show-title cls" ng-if="showTitle">{{showTitle}}</div>
            <div ng-if="card.parentName" class="parentinfo">所属：{{card.parentName}}</div>
            <ul>
                <li><label class="k"><em class="red">*</em>标题：</label><span class="v"><textarea ng-model="card.title" required rows="2" class="title"></textarea></span></li>
                <li><label class="k"><em class="red">*</em>工作量：</label>
                    <span class="v"><input type="text" onKeypress="return (/[-\d.]/.test(String.fromCharCode(event.keyCode)))" ng-model="card.amount" required class="amount"/>天　<span class="real-amount" ng-if="card.objectId">实际：<input type="text" onKeypress="return (/[-\d.]/.test(String.fromCharCode(event.keyCode)))" ng-model="card.realAmount" class="amount"/>天</span>
                        　　　　从 <input  tabindex="-1" readonly type="text" class="datetime" ng-model="card.startTime" value="{{card.startTime | date:'yyyy-MM-dd'}}" datetime="datetime"/> 至 <input  tabindex="-1" readonly  ng-model="card.endTime" type="text" class="datetime" datetime="datetime" value="{{card.endTime | date:'yyyy-MM-dd'}}"/>
                    </span></li>
                <li><label class="k"><em class="red">*</em>描述：</label><span class="v"><textarea ng-model="card.description" required rows="3" class="descri" name="descri"></textarea></span></li>
                <li><label class="k">优先级：</label>
                    <span class="v"><input type="number" ng-model="card.weight" class="amount"/>
                        <span ng-if="(card.type!='story')">　种类:
                    <select title="选择添加用户" ng-model="card.cardClass" name="owners" class="card-class">
                        <option  ng-repeat="cardClass in cardClassList" value="{{cardClass}}">{{cardClass}}</option>
                    </select>
                        　　所属故事 : <select style="max-width:140px;" title="选择该任务到其他故事" ng-model="card.parentId" name="owners" class="card-class" ng-change="movetostory('{{card.parentId}}',card)">
                                <option  ng-repeat="story in storyList" value="{{story.objectId}}">{{story.title}}</option>
                            </select>
                        </span>
                        <span ng-if="(card.type=='0')">
                        　　所属冲刺 : <select style="max-width:140px;" title="选择该故事到其他冲刺" ng-model="card.sprintId" name="owners" class="card-class" ng-change="movetosprint('{{card.sprintId}}',card)">
                                <option  ng-repeat="sprint in sprintList" value="{{sprint.id}}">{{sprint.name}}</option>
                            </select>
                        </span>
                    </span>
                </li>
                <li><label class="k">负责人：</label><span class="v">
                    <span class="peo-wrap"><em title="右键删除" rightclick="deletePeo(card,peo.objectId)" ng-repeat="peo in card.owners">{{peo.displayName}}</em></span>
                    <select class="owner-select" ng-change="change(cacheS)" title="选择添加用户" ng-model="cacheS" name="owners" ng-options="owner.objectId as owner.displayName for owner in companyPeople">
                    </select></span>
                </li>
                <li class="imgs"><label class="k">图片：</label>
                    <span class="v">
                        <span class="imgs-wrap" ng-cloak><img ng-click="showimg()" title="右键删除" ng-repeat="img in card.images" ng-if="!img.deleted" rightclick="deletePic(card,img.id)"  ng-src="{{img.url}}"/></span>
                        <span class="uploadbtn {{loading}}">
                            <span class="text"><span class="normal">截屏  ctrl+v</span><i>+</i></span>
                            <span class="status">{{loadStatus}}</span>
                            <input tabindex="-1" class="fileupload" type="file" name="mypic" onchange="angular.element(this).scope().onFileSelect(this.files)"/>
                        </span>
                    </span>
                </li>
                <li><span class="k"></span><span class="v"><input  ng-disabled="ajaxing" type="submit" class="btn" value="保 存" /><span class="createdby" ng-if="card.createdBy">{{card.createdBy.userName}} 创建于 {{card.createdAt | date : 'yyyy-MM-dd HH:mm'}}</span></span></li>
            </ul>
            <span class="close" ng-click="closepanel()">×</span>
        </form>
        <div class="comment" ng-if="card.objectId">
            <ul>
               <li ng-repeat="comment in comments | orderBy:'updatedAt':'reverse'">
                   <div class="cont">{{comment.description}}</div>
                   <div class="info"><span class="time">{{comment.createdAt | date : 'yyyy-MM-dd HH:mm'}}</span><span class="name">{{comment.createdBy.displayName}}</span></div>
               </li>
            </ul>
        </div>
        <div class="comment-input-wrap">
            <textarea maxlength="200" ng-disabled="commenting"  ng-keypress="ctrlenter($event)" class="comment-input" ng-model="cacheCom" placeholder="ctrl+enter提交（200字内）"></textarea>
        </div>
        <div ng-if="card.createdBy.userId | iscurrentUser" class="delcard" ng-click="delcard()">删除</div>
    </div>
</div>
<script>
    seajs.use(["angular","angular-animate","tools","directive"],function(){
        tplData.sprintId = tplData.sprintId || tplData.sprints[0].id;
         var app = angular.module('card', ['ngAnimate','ngDirective']);
        app.filter("ownersname",function(){
            return function(owners){
                var arr_name = [];
                for(var i=0;i<owners.length;i++){
                    arr_name.push(owners[i].displayName);
                }
                return arr_name.join(",");
            }
        });
        app.filter("ftime",function(){
            return function(str){
                var t = new Date(str.replace("-","/"));
                return (t.getMonth()+1) +"."+ t.getDate();
            }
        });
        app.filter("expend",function(){
            return function(expendId,itemInd){
                if(expendId!=undefined){
                    if(itemInd == expendId){
                        return 1;
                    }else{
                        return 0;
                    }
                }else{
                    return 1;
                }
            }
        });
        app.filter("showline",function(){
            return function(obj){
                if(obj.story.deleted == 1){
                    return 0;
                }else{
                    return 1;
                }
            }
        });
        app.filter("filterpeople",function(){
            return function(item,ownerId){
                if(item.deleted==1){
                    return 0;
                }
                if(ownerId == "all"){
                    return 1;
                };
                var res = 0;
                for(var i=0;i<item.owners.length;i++){
                    if(ownerId == item.owners[i].objectId){
                        res = 1;
                        break;
                    }
                }
                return res;
            }
        });
        app.filter("iscurrentUser",function(){
            return function(id){
                if(tplData.user.id==id){
                    return 1;
                }else{
                    return 0;
                }
            }
        });
        app.controller("body",function($scope){
            $scope.$on("headChange",function (event, obj) {
                $scope.$broadcast("filterChange", obj);
            });
            $scope.$on("addCard",function(event,data){
                $scope.$broadcast("showDetail",data);
            });
            $scope.$on("addnewCard",function(event,data){
                $scope.$broadcast("addedCard",data);
            });
            $scope.$on("modefyCard",function(event,data){
                $scope.$broadcast("showDetail",data);
            });
            $scope.$on("drop",function(event,data){
                $scope.$broadcast("dropcard",data);
            });
        });
        app.controller('head', function($scope,$http) {
            $scope.scope = $scope;
            $scope.teams = tplData.teams;
            $scope.teamId=tplData.teamId;
            $scope.sprintId =tplData.sprintId;
            $scope.sprints = tplData.sprints;
            $scope.companyPeople=[{"objectId":"all","displayName":"全部"}];//下拉选择添加全部
            $scope.ownerId="all";
            $scope.statistics = "/statistics?teamId="+$scope.teamId+"&sprintId="+$scope.sprintId;
            for(var i=0;i<tplData.companyPeople.length;i++){
                var inteam = 0;
                for(var j=0;j<tplData.companyPeople[i].teams.length;j++){
                    if(tplData.companyPeople[i].teams[j].teamId == $scope.teamId){
                        inteam = 1;
                    }
                }
                if(inteam){
                    $scope.companyPeople.push(tplData.companyPeople[i])
                }
            }
            $scope.change = function (isname) {
                $scope.statistics = "/statistics?teamId="+$scope.teamId+"&sprintId="+$scope.sprintId;
                if(isname){
                    $scope.$emit("headChange", {sprintId:$scope.sprintId,teamId:$scope.teamId,ownerId:$scope.ownerId});
                }else{
                    location.href = "/?teamId="+$scope.teamId+"&sprintId="+$scope.sprintId;
                }
            };
        });
        app.controller('list', function($scope,$rootScope,$http) {
            $scope.cardType = tplData.curTeam.cardType;
            $scope.filterid = "all";
            render({sprintId:tplData.sprintId,teamId:tplData.teamId,ownerId:"all"});
            function render(obj){
                var url = "/ajax?type=get-card-list&sprintId="+ obj.sprintId+"&teamId="+obj.teamId;
                    $http.get(url).then(function(data){
                        tplData.cardList = $scope.cardList = data.data.result;
                    },function(data){});
                }
            $scope.cardclick=function(data){
                $scope.$emit("modefyCard",data);
            };
            $scope.$on("moveCard",function(event,data){
                $scope.$apply();
                var url = "/ajax?type=card-move&cardId="+data.item.objectId+"&newType="+data.item.type;
                $http.get(url).success(function(res){
                    if(res.status != 1) {
                        alert("修改失败！");
                        location.reload();
                    }
                });
            });
            $scope.addcard=function(data){
                var cur_obj = JSON.parse(JSON.stringify(data));
                cur_obj.cardList = $scope.cardList;
                $scope.$emit("addCard",cur_obj);
            };
            $scope.screen=function(ind){
                if($scope.expendind == ind){
                    $scope.expendind =  undefined;
                }else{
                    $scope.expendind = ind;
                }
            }
            $scope.orderfunc=function(data){
                return data.story.weight;
            };
            $scope.$on("addedCard",function(event,data){
                if(data.type == "story"){
                    var arr = [];
                    tplData.curTeam.cardType.forEach(function(name){
                        arr.push({type:name,list:[]});
                    });
                    $scope.cardList.push({cards:arr,story:data});
                }else if(data.parentId){
                    for(var i=0;i<$scope.cardList.length;i++){
                        if(data.parentId == $scope.cardList[i].story.objectId){
                            for(var j=0;j<$scope.cardList[i].cards.length;j++){
                                if($scope.cardList[i].cards[j].type == data.type){
                                    $scope.cardList[i].cards[j].list.push(data);
                                    break;
                                }
                            }
                            break;
                        }
                    }

                }
            });
            $scope.$on("filterChange",function (event, obj) {
                $scope.filterid = obj.ownerId;
            });
        });
        app.controller('cardDetail',function($scope,$rootScope,$http){
            $scope.show = 0;
            $scope.cardClassList = tplData.curTeam.cardClass;
            $scope.storyList = [];
            $scope.sprintList = tplData.sprints;
            $scope.closepanel= function(){
                $scope.show = 0;
                if($scope.card.sprintId != $scope.oldData.sprintId || $scope.card.parentId != $scope.oldData.parentId){
                    //页面数据回滚
                    tplData.cardList.forEach(function(arr,ind){
                        tplData.cardList[ind] =  $scope.oldCardList[ind];
                    });
                }else{
                    for(var key in $scope.card){//数据回滚
                        $scope.card[key]=$scope.oldData[key];
                    }
                }
            };
            $scope.$on("showDetail",function(event,data){
                if($scope.storyList.length == 0){
                    tplData.cardList.forEach(function(item){
                        $scope.storyList.push(item.story);
                    });
                }
                $scope.oldData = JSON.parse(JSON.stringify(data));
                $scope.oldCardList = JSON.parse(JSON.stringify(tplData.cardList));
                $scope.show = 1;
                $scope.ajaxing = 0;
                $scope.cacheComment = "";
                $scope.companyPeople =tplData.companyPeople;
                if(data && data.hasComments == 1){
                    //获取评论
                    $http.get("/ajax?type=get-comments&cardId="+data.objectId).then(function(data){
                        $scope.comments = data.data.result;
                    });
                }else{
                    $scope.comments=[];
                }
                if(data && data.objectId){
                    //修改卡片
                    $scope.card = data;
                    $scope.showTitle="";
                    $scope.submit=function(e){
                        $scope.ajaxing = 1;
                        var url = "/ajax?type=update-card&teamId="+tplData.teamId+"&sprintId="+tplData.sprintId+"&cardId="+$scope.card.objectId;
                        $http.post(url,$scope.card).success(function(data){
                            if(data.status == 1) {
                                $scope.show = 0;
                            }else{
                                alert("修改卡片失败");
                            }
                            $scope.ajaxing = 0;
                        });
                    };
                }else{
                    //新建卡片
                    if(data.parentId){
                        $scope.showTitle="新建任务";
                        $scope.card={images:[],weight:1,cardClass:"任务",owners:[],type:tplData.curTeam.cardType[0],parentId:data.parentId,parentName:data.parentName};
                    }else{
                        $scope.showTitle="新建故事";
                        $scope.card={images:[],owners:[],type:data.type,weight:1};
                    }
                    $scope.submit=function(e){
                        $scope.ajaxing = 1;
                        var url = "/ajax?type=add-card&teamId="+tplData.teamId+"&sprintId="+tplData.sprintId;
                        $http.post(url,$scope.card).success(function(data){
                            if(data.status == 1) {
                                $scope.$emit("addnewCard",data.result);
                                $scope.show = 0;
                            }else{
                                alert("新建卡片失败");
                            }
                            $scope.ajaxing = 0;
                        });
                    };
                }
            });
            $scope.change=function(id){
                var ret = 0;
                $scope.card.owners.forEach(function(obj){
                    if(obj.objectId == id){
                        ret = 1;
                    }
                });
                if(ret){return};
                for(var i=0;i<$scope.companyPeople.length;i++){
                    if(id==$scope.companyPeople[i].objectId){
                        $scope.card.owners.push($scope.companyPeople[i]);
                        break;
                    }
                }
                delete $scope.cacheS;
            };
            $scope.movetostory = function(parentId,card){
                tplData.cardList.forEach(function(item){
                    if(item.story.objectId == parentId){
                        item.cards.forEach(function(cardlist){
                            cardlist.list.forEach(function(cur_card,ind){
                                if(cur_card.objectId == card.objectId){
                                    cardlist.list.splice(ind,1);
                                }
                            })
                        });
                    }
                    if(item.story.objectId == card.parentId){
                        item.cards.forEach(function(cardlist){
                            if(cardlist.type == card.type){
                                cardlist.list.push(card);
                            }
                        });
                    }
                });
            };
            $scope.movetosprint = function(sprintId,card){
                if(card.sprintId != tplData.sprintId){
                    tplData.cardList.forEach(function(item,ind){
                        if(card.objectId == item.story.objectId){
                            tplData.cardList.splice(ind,1);
                        }
                    });
                }else{
                    //数据还原
                    $scope.oldCardList.forEach(function(arr,ind){
                        tplData.cardList[ind] =  $scope.oldCardList[ind];
                    });
                }
            };
            $scope.showimg=function(){
                var openwindow=window.open("","","location=no,fullscreen=yes");
                openwindow.document.write("<style type='text/css'>*{padding:0;margin:0}body{text-align:center;padding:10px;}img{border:1px solid #ddd;padding:1px;}</style>");
                openwindow.document.write("<img style='max-width:100%' src='"+this.img.url+"'/>");
                openwindow.document.title="查看图片";
            };
            $scope.ctrlenter = function(ev) {
                if($scope.commenting == 1) return;
                var textarea = ev.target,val= textarea.value.trim();
                if (ev.ctrlKey == true && (ev.keyCode == 13||ev.keyCode == 10) && val.length>0){
                    $scope.commenting = 1;
                    var url = "/ajax?type=add-comment&cardId="+$scope.card.objectId+"&description="+encodeURIComponent(val)+"&hasComments="+$scope.card.hasComments;
                    $http.get(url).then(function(data){
                      if(data.data.status == 1){
                            $scope.card.hasComments = "1";
                            $scope.comments.push(data.data.result);
                            textarea.value="";
                      }else{
                            alert("添加评论失败！");
                      }
                        $scope.commenting=0;
                    },function(data){
                        $scope.commenting=0;
                    });
                }
            };
            $scope.deletePeo=function(card,objectId){
                for(var i=0;i<card.owners.length;i++) {
                    if (card.owners[i].objectId == objectId) {
                        card.owners.splice(i, 1);
                    }
                }
            };
            $scope.deletePic=function(card,imgId){
                for(var i=0;i<card.images.length;i++){
                    if(card.images[i].id == imgId){
                        card.images[i].deleted = 1;
                        break;
                    }
                }
            };
            $scope.delcard=function(cardId){
                var url = "/ajax?type=del-card&cardId="+$scope.card.objectId;
                $http.get(url).then(function(data){
                    if(data.data.status == 1){
                        $scope.card.deleted = "1";
                        $scope.show=0;
                    }else{
                        alert("删除失败！");
                    }
                    $scope.commenting=0;
                },function(data){
                    $scope.commenting=0;
                });
            }
        });
    });
</script>
{%include "layout/footer"%}
