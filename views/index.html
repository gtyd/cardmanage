{%include "layout/header"%}
<link rel="stylesheet" href="/public/css/style.css"/>
<div class="body cls"  ng-app="card" ng-controller="body">
    <div id="header" class="header" ng-controller="head">
        <h2>敏捷管理平台</h2>
        <form id="filter" class="filter">
            <label for="groupfilter">组：</label>
            <select ng-cloak name="groupfilter" id="groupfilter" ng-model="teamId"  ng-change="change()">
                <option ng-repeat="val in teams" value="{{val.teamId}}">{{val.teamName}}</option>
            </select>
           <label for="dateselect">区间：</label>
            <select ng-cloak name="dateselect" id="dateselect" ng-model="sprintId"  ng-change="change()">
                <option ng-repeat="val in sprints" value="{{val.id}}">{{val.name}}</option>
            </select>
            <label for="filterpeo">责任人：</label>
            <select ng-cloak name="dateselect" id="filterpeo" ng-model="ownerId" ng-change="change(1)">
                <option ng-repeat="val in companyPeople" value="{{val.objectId}}">{{val.username}}</option>
            </select>
        </form>
        <a class="statistics" href="{{statistics}}">查看统计</a>
        <span class="notice"></span>
        <span class="user" ng-cloak>欢迎：{%user.username%}</span>
    </div>
    <div id="content" ng-cloak class="content cls" ng-controller="list">
        <table class="table">
            <thead>
                <tr>
                    <td style="width:100px;">故事 <em ng-click="addcard({'type':'story'})">添加</em></td>
                    <td ng-repeat="value in cardType">{{value}}</td>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="lineobj in cardList | orderBy:orderfunc:'reverse'">
                    <td>
                        <div class="story-card" ng-dblclick="cardclick(lineobj.story)">
                            {{lineobj.story.title}}
                            <div class="story-add-card" ng-click="addcard({'parentId':lineobj.story.objectId,'parentName':lineobj.story.title})" title="添加任务">+</div>
                        </div>
                    </td>
                    <td dropable dataitem="cardtype" ng-repeat="cardtype in lineobj.cards" data-parentid="{{lineobj.story.objectId}}">
                        <div ng-if="item | filterpeople:filterid" draggable item="item" itemtype="cardtype" class="card"  ng-dblclick="cardclick(item)" ng-repeat="item in cardtype.list | orderBy:'weight':'reverse'">
                            <h4>{{item.title}}</h4>
                            <ul class="ownerslist cls">
                                <li class="name owner">责任人:</li>
                                <li class="owner">{{item.owners | ownersname}}</li>
                            </ul>
                            <div class="completetime"><span class="owner">工作量:</span><span class="owner">{{item.amount}}天</span></div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="carddetail" ng-cloak ng-show="show" ng-controller="cardDetail" paste>
        <form class="addcard ng-pristine ng-valid" ng-submit="submit()">
            <div ng-if="card.parentName" class="parentinfo">所属：{{card.parentName}}</div>
            <ul>
                <li><label class="k"><em class="red">*</em>标题：</label><span class="v"><textarea ng-model="card.title" required rows="2" class="title"></textarea></span></li>
                <li ng-if="(card.type!='story')"><label class="k"><em class="red">*</em>工作量：</label><span class="v"><input type="text" ng-model="card.amount" required class="amount"/>天　　　<span class="real-amount" ng-if="card.objectId">实际：<input type="text" ng-model="card.realAmount" class="amount"/>天</span></span></li>
                <li><label class="k"><em class="red">*</em>描述：</label><span class="v"><textarea ng-model="card.description" required rows="3" class="descri" name="descri"></textarea></span></li>
                <li><label class="k">优先级：</label><span class="v"><input type="text" ng-model="card.weight" class="amount"/></span></li>
                <li><label class="k">负责人：</label><span class="v">
                    <span class="peo-wrap"><em title="右键删除" rightclick="deletePeo(card,peo.objectId)" ng-repeat="peo in card.owners">{{peo.username}}</em></span>
                    <select ng-change="change(cacheS)" title="选择添加用户" ng-model="cacheS" name="owners" ng-options="owner.objectId as owner.username for owner in companyPeople">
                    </select></span>
                </li>
                <li class="imgs"><label class="k">图片：</label>
                    <span class="v">
                        <span class="imgs-wrap" ng-cloak><img ng-click="showimg()" title="右键删除" ng-repeat="img in card.images" ng-if="!img.deleted" rightclick="deletePic(card,img.id)"  ng-src="{{img.url}}"/></span>
                        <span class="uploadbtn {{loading}}">
                            <span class="text"><span class="normal">截屏  ctrl+v</span><i>+</i></span>
                            <span class="status">{{loadStatus}}</span>
                            <input tabindex="-1" class="fileupload" type="file" name="mypic" onchange="angular.element(this).scope().onFileSelect(this.files)"/>
                        </span>
                    </span>
                </li>
                <li><span class="k"></span><span class="v"><input  ng-disabled="ajaxing" type="submit" class="btn" value="提交" /><span class="createdby" ng-if="card.createdBy">{{card.createdBy.userName}} 创建于 {{card.createdAt | date : 'yyyy-MM-dd HH:mm'}}</span></span></li>
            </ul>
            <span class="close" ng-click="closepanel()">×</span>
        </form>
        <div class="comment" ng-if="card.objectId">
            <h4>留言：</h4>
            <ul>
               <li ng-repeat="comment in comments">
                   <div class="cont">{{comment.description}}</div>
                   <div class="info"><span class="time">{{comment.createdAt | date : 'yyyy-MM-dd HH:mm'}}</span><span class="name">{{comment.createdBy.username}}</span></div>
               </li>
                <li>
                    <textarea maxlength="200" ng-disabled="commenting"  ng-keypress="ctrlenter($event)" class="comment-input" ng-model="cacheCom" placeholder="ctrl+enter提交（200字内）"></textarea>
                </li>
            </ul>
        </div>
        <div ng-if="card.createdBy.userId | iscurrentUser" class="delcard" ng-click="delcard()">删除</div>
    </div>
</div>
<script>
    seajs.use(["angular","angular-animate"],function(){
         var app = angular.module('card', ['ngAnimate']);
        app.filter("ownersname",function(){
            return function(owners){
                var arr_name = [];
                for(var i=0;i<owners.length;i++){
                    arr_name.push(owners[i].username);
                }
                return arr_name.join(",");
            }
        });
        app.filter("filterpeople",function(){
            return function(item,ownerId){
                if(ownerId == "all"){
                    return 1;
                };
                var res = 0;
                for(var i=0;i<item.owners.length;i++){
                    if(ownerId == item.owners[i].objectId){
                        res = 1;
                        break;
                    }
                }
                return res;
            }
        });
        app.filter("iscurrentUser",function(){
            return function(id){
                if(tplData.user.id==id){
                    return 1;
                }else{
                    return 0;
                }
            }
        });
        app.controller("body",function($scope){
            $scope.$on("headChange",function (event, obj) {
                $scope.$broadcast("filterChange", obj);
            });
            $scope.$on("addCard",function(event,data){
                $scope.$broadcast("showDetail",data);
            });
            $scope.$on("addnewCard",function(event,data){
                $scope.$broadcast("addedCard",data);
            });
            $scope.$on("modefyCard",function(event,data){
                $scope.$broadcast("showDetail",data);
            });
            $scope.$on("drop",function(event,data){
                $scope.$broadcast("dropcard",data);
            });
        });
        app.controller('head', function($scope,$http) {
            $scope.scope = $scope;
            $scope.teams = tplData.teams;
            $scope.teamId=tplData.teamId || tplData.teams[0].teamId;
            $scope.sprintId =tplData.sprintId || tplData.sprints[0].id;
            $scope.sprints = tplData.sprints;
            $scope.companyPeople=[{"objectId":"all","username":"全部"}];//下拉选择添加全部
            $scope.ownerId="all";
            $scope.statistics = "/statistics?teamId="+$scope.teamId+"&sprintId="+$scope.sprintId;
            for(var i=0;i<tplData.companyPeople.length;i++){
                var inteam = 0;
                for(var j=0;j<tplData.companyPeople[i].teams.length;j++){
                    if(tplData.companyPeople[i].teams[j].teamId == $scope.teamId){
                        inteam = 1;
                    }
                }
                if(inteam){
                    $scope.companyPeople.push(tplData.companyPeople[i])
                }
            }
            $scope.change = function (isname) {
                $scope.statistics = "/statistics?teamId="+$scope.teamId+"&sprintId="+$scope.sprintId;
                if(isname){
                    $scope.$emit("headChange", {sprintId:$scope.sprintId,teamId:$scope.teamId,ownerId:$scope.ownerId});
                }else{
                    location.href = "/?teamId="+$scope.teamId+"&sprintId="+$scope.sprintId;
                }
            };
        });
        app.controller('list', function($scope,$rootScope,$http) {
            $scope.cardType = tplData.curTeam.cardType;
            $scope.filterid = "all";
            render({sprintId:tplData.sprintId||tplData.sprints[0].id,teamId:tplData.teamId,ownerId:"all"});
            function render(obj){
                    var url = "/ajax?type=get-card-list&sprintId="+ obj.sprintId+"&teamId="+obj.teamId;
                    $http.get(url).then(function(data){
                        tplData.cardList = $scope.cardList = data.data.result;
                    },function(data){});
                }
            $scope.cardclick=function(data){
                $scope.$emit("modefyCard",data);
            };
            $scope.$on("moveCard",function(event,data){
                $scope.$apply();
                var url = "/ajax?type=card-move&cardId="+data.item.objectId+"&newType="+data.item.type;
                $http.get(url).success(function(res){
                    if(res.status != 1) {
                        alert("修改失败！");
                        location.reload();
                    }
                });
            });
            $scope.addcard=function(data){
                var cur_obj = JSON.parse(JSON.stringify(data));
                cur_obj.cardList = $scope.cardList;
                $scope.$emit("addCard",cur_obj);
            };
            $scope.orderfunc=function(data){
                return data.story.weight;
            };
            $scope.$on("addedCard",function(event,data){
                if(data.type == "story"){
                    var arr = [];
                    tplData.curTeam.cardType.forEach(function(name){
                        arr.push({type:name,list:[]});
                    });
                    $scope.cardList.push({cards:arr,story:data});
                }else if(data.parentId){
                    for(var i=0;i<$scope.cardList.length;i++){
                        if(data.parentId == $scope.cardList[i].story.objectId){
                            for(var j=0;j<$scope.cardList[i].cards.length;j++){
                                if($scope.cardList[i].cards[j].type == data.type){
                                    $scope.cardList[i].cards[j].list.push(data);
                                    break;
                                }
                            }
                            break;
                        }
                    }

                }
            });
            $scope.$on("filterChange",function (event, obj) {
                $scope.filterid = obj.ownerId;
            });
        });
        app.controller('cardDetail',function($scope,$rootScope,$http){
            $scope.show = 0;
            $scope.closepanel= function(){
                $scope.show = 0;
            };
            $scope.$on("showDetail",function(event,data){
                $scope.show = 1;
                $scope.cacheComment = "";
                $scope.companyPeople =tplData.companyPeople;
                if(data && data.hasComments == 1){
                    //获取评论
                    $http.get("/ajax?type=get-comments&cardId="+data.objectId).then(function(data){
                        $scope.comments = data.data.result;
                    });
                }else{
                    $scope.comments=[];
                }
                if(data && data.objectId){
                    //修改卡片
                    $scope.card = data;
                    $scope.submit=function(e){
                        $scope.ajaxing = 1;
                        var url = "/ajax?type=updata-card&teamId="+tplData.teamId+"&sprintId="+tplData.sprintId+"&cardId="+$scope.card.objectId;
                        $http.post(url,$scope.card).success(function(data){
                            if(data.status == 1) {
                                $scope.show = 0;
                            }
                            $scope.ajaxing = 0;
                        });
                    };
                }else{
                    //新建卡片
                    if(data.parentId){
                        $scope.card={images:[],owners:[],type:tplData.curTeam.cardType[0],parentId:data.parentId,parentName:data.parentName};
                    }else{
                        $scope.card={images:[],owners:[],type:data.type};
                    }
                    $scope.submit=function(e){
                        $scope.ajaxing = 1;
                        var url = "/ajax?type=add-card&teamId="+tplData.teamId+"&sprintId="+tplData.sprintId;
                        $http.post(url,$scope.card).success(function(data){
                            if(data.status == 1) {
                                $scope.$emit("addnewCard",data.result);
                                $scope.show = 0;
                            }
                            $scope.ajaxing = 0;
                        });
                    };
                }
            });
            $scope.change=function(id){
                var ret = 0;
                $scope.card.owners.forEach(function(obj){
                    if(obj.objectId == id){
                        ret = 1;
                    }
                });
                if(ret){return};
                for(var i=0;i<$scope.companyPeople.length;i++){
                    if(id==$scope.companyPeople[i].objectId){
                        $scope.card.owners.push($scope.companyPeople[i]);
                        break;
                    }
                }
                delete $scope.cacheS;
            };
            $scope.showimg=function(){
                var openwindow=window.open("","","location=no,fullscreen=yes");
                openwindow.document.write("<style type='text/css'>*{padding:0;margin:0}body{text-align:center;padding:10px;}img{border:1px solid #ddd;padding:1px;}</style>");
                openwindow.document.write("<img style='max-width:100%' src='"+this.img.url+"'/>");
                openwindow.document.title="查看图片";
            };
            $scope.ctrlenter = function(ev) {
                if($scope.commenting == 1) return;
                var textarea = ev.target,val= textarea.value.trim();
                if (ev.ctrlKey == true && (ev.keyCode == 13||ev.keyCode == 10) && val.length>0){
                    $scope.commenting = 1;
                    var url = "/ajax?type=add-comment&cardId="+$scope.card.objectId+"&description="+encodeURIComponent(val)+"&hasComments="+$scope.card.hasComments;
                    $http.get(url).then(function(data){
                      if(data.data.status == 1){
                            $scope.card.hasComments = "1";
                            $scope.comments.push(data.data.result);
                            textarea.value="";
                      }else{
                            alert("添加评论失败！");
                      }
                        $scope.commenting=0;
                    },function(data){
                        $scope.commenting=0;
                    });
                }
            };
            $scope.deletePeo=function(card,objectId){
                for(var i=0;i<card.owners.length;i++) {
                    if (card.owners[i].objectId == objectId) {
                        card.owners.splice(i, 1);
                    }
                }
            };
            $scope.deletePic=function(card,imgId){
                for(var i=0;i<card.images.length;i++){
                    if(card.images[i].id == imgId){
                        card.images[i].deleted = 1;
                        break;
                    }
                }
            };
            $scope.delcard=function(cardId){
                var url = "/ajax?type=del-card&cardId="+$scope.card.objectId;
                $http.get(url).then(function(data){
                    if(data.data.status == 1){
                        $scope.card.deleted = "1";
                        $scope.show=0;
                    }else{
                        alert("删除失败！");
                    }
                    $scope.commenting=0;
                },function(data){
                    $scope.commenting=0;
                });
            }
        });
        app.directive('minheight',function($window){
            return function(scope,element,attr){
                element.css({"min-height":$window.innerHeight-75+"px"});
                $window.addEventListener("resize",function(){
                    element.css({"min-height":$window.innerHeight-75+"px"});
                });
            };
        });
        app.directive('paste',function(){
            return {
                restrict:"EA",
                link:function(scope,element){
                    element.on("paste",function(e){
                        var clipboardData = e.clipboardData,i = 0, item,fd = new FormData();
                        if(clipboardData && clipboardData instanceof DataTransfer){
                            for(i=0 ; i < clipboardData.items.length; i++ ){
                                if( clipboardData.items[i]["kind"] === 'file'&&clipboardData.items[i]["type"].match(/^image\//i)){
                                    item = clipboardData.items[i];
                                    break;
                                }
                            };
                            var blob = item&&item.getAsFile();
                            if(!blob||!blob.type) return;//正常粘贴行为，返回
                            if(blob.type.match(/^image\//i)&&blob.size>0){
                                fd.append('file', blob);
                                startupload(fd,"/upload",loadprogress,loadsuccess,loaderror);
                            }else if(blob.type.match(/^image\//i)&&!blob.size){
                                alert("不能粘贴,请用截屏软件截屏后粘贴！");
                            };
                        }
                    });
                    scope.loadStatus = "上传…";
                    scope.onFileSelect=function(file){
                        var fd = new FormData();
                        fd.append('file', file[0]);
                        startupload(fd,"/upload",loadprogress,loadsuccess,loaderror);
                    };
                    function startupload(formData,url,progress,success,error){
                        if(scope.loading == "loading") return;
                        scope.loading = "loading";
                        scope.$apply();
                        var xhr = new XMLHttpRequest();
                        xhr.open("post", url, true);
                        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                        xhr.upload.addEventListener("progress",progress,false);
                        xhr.addEventListener("load",function(){
                            success(JSON.parse(xhr.responseText));
                        },false);
                        xhr.addEventListener("error",error,false);
                        xhr.send(formData);
                    }
                    function loaderror(){
                        var btn_wrap = element.find(".uploadbtn");
                        var input_html = '<input tabindex="-1" class="fileupload" type="file" name="mypic">';
                        btn_wrap.append(input_html);
                        alert("上传失败！");
                    }
                    function loadsuccess(data){
                        scope.card.images.push({url:data.result.url,name:data.result.name,id:data.result.id});
                        if(data.status==1){
                            scope.loading = "";
                            scope.loadStatus = "上传…";
                        }
                        scope.$apply();
                    }
                    function loadprogress(e){
                        scope.loadStatus = Math.ceil(e.loaded/ e.total * 100) + "%";
                        scope.$apply();
                    }
                }
            }
        });
        app.directive('draggable', function($document,$rootScope) {
            return {
                restrict:"EA",
                scope:{
                    item:'=item',
                    itemtype:'=itemtype'
                },
                link:function(scope, element, attrs) {
                    var startX=0, startY=0, x = 0, y = 0,minY,maxY;
                    var wrap = document.querySelectorAll("[dropable]");
                    element.css({
                        position: 'relative',
                        cursor:"default"
                    });
                    element.bind('mousedown', function(event) {
                        var parentOffset = element.parent()[0].getBoundingClientRect(),domOffset = element[0].getBoundingClientRect();
                        minY = parentOffset.top - domOffset.top;
                        maxY = parentOffset.bottom - domOffset.bottom;
                        startX = event.screenX - x;
                        startY = event.screenY - y;
                        $document.bind('mousemove', mousemove);
                        $document.bind('mouseup', mouseup);
                    });
                    function mousemove(event) {
                        y = event.screenY - startY;
                        x = event.screenX - startX;
                        if(y<minY) y = minY;
                        if(y>maxY) y=maxY;
                        element.addClass("draging").css({
                            top: y + 'px',
                            left:  x + 'px'
                        });
                    }
                    function mouseup(event) {
                        element.removeClass("draging");
                        $document.unbind('mousemove', mousemove);
                        $document.unbind('mouseup', mouseup);
                        for(var i=0;i<wrap.length;i++){
                            var cur_wrap = wrap[i];
                            if(inSideDom(element[0],cur_wrap)){
                                //element.addClass("moving");
                                scope.$emit("drop",{cur_wrap:cur_wrap,item:scope.item,itemtype:scope.itemtype});
                                break;
                            }
                        }
                        element.css({top:0,left:0});
                        startX=0;startY=0; x = 0;y = 0;
                    }
                }
            }
            function inSideDom(tag,dom){
                var curRectObj = dom.getBoundingClientRect(),rectObj = tag.getBoundingClientRect();
                var point = {
                    y:rectObj.top + rectObj.height/2,
                    x:rectObj.left + rectObj.width/2
                };
                if(point.x > curRectObj.left && point.x<curRectObj.left+curRectObj.width && point.y > curRectObj.top && point.y < curRectObj.top+curRectObj.height){
                    return true;
                }else{
                    return false;
                }
            }
        });
        app.directive('dropable',function(){
            return {
                restrict:"EA",
                scope:{
                    dataItem:'=dataitem'
                },
                link:function(scope, element,attrs){
                    scope.$on("dropcard",function(e,data){
                        if(data.cur_wrap == element[0] && scope.dataItem != data.itemtype){
                            for(var i=0;i<data.itemtype.list.length;i++){
                                if(data.item == data.itemtype.list[i]){
                                    data.itemtype.list.splice(i,1);
                                }
                            }
                            data.item.type=scope.dataItem.type;
                            scope.dataItem.list.push(data.item);
                            scope.$emit("moveCard",{originList:data.itemtype.list,curList:scope.dataItem.list,item:data.item});
                        }
                    });
                }

            }
        });
        app.directive('rightclick', function($parse) {
            return function(scope, element, attrs) {
                var fn = $parse(attrs.rightclick);
                element.bind('contextmenu', function(event) {
                    scope.$apply(function() {
                        event.preventDefault();
                        fn(scope, {$event:event});
                    });
                });
            };
        });
    });
</script>
{%include "layout/footer"%}
